# postgresQL

## issues

| The data directory was initialized by PostgreSQL version 12, which is not compatible with this version 14.1.  
`brew postgresql-upgrade-database`

## on Mac

- execute postgresql
  - `psql <user>` ex) `psql postgres`
- if you don't have user postgres(default user)
  - `/usr/local/opt/postgres/bin/createuser -s postgres`
- show all databases
  - `psql -l`

## Commands in postgresql terminnal

- `\du`: show database users

## RLS(Row Level Security)

[article1](https://www.2ndquadrant.com/en/blog/application-users-vs-row-level-security/)

## CREATE FUNCTION (user-defined function)

```sql
CREATE FUNCTION set_username(uname TEXT, pwd TEXT) RETURNS text AS $
DECLARE
    v_key   TEXT;
    v_value TEXT;
BEGIN
    SELECT sign_key INTO v_key FROM secrets;
    v_value := uname || ':' || extract(epoch from now())::int;
    v_value := v_value || ':' || crypt(v_value || ':' || v_key,
                                       gen_salt('bf'));
    PERFORM set_config('my.username', v_value, false);
    RETURN v_value;
END;
$ LANGUAGE plpgsql SECURITY DEFINER STABLE;
```

### PL/pgSQL

in above block, create-function using 'PL/pgSQL'
### SELECT ... INTO ...

assign result of SELECT query into some VARIABLE

### extract(... from now())

extract specific field of datetime value from now

### crypt(txt, salt)

salt can be generated by using `gen_salt(crypting method)`  

supported crypting methods

- bf
- md5
etc

### PERFORM

query without return

### set_config(setting_name, new_value, is_local)

[docs](https://www.postgresql.org/docs/9.3/functions-admin.html#FUNCTIONS-ADMIN-SET-TABLE)

set config with parameter.
if `is_local` is true, use this config only for this transactions.
